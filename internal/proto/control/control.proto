syntax = "proto3";

package control;

option go_package = "github.com/knakatasf/wiki-river/internal/proto/control;controlpb";

enum StageKind {
  STAGE_KIND_UNSPECIFIED = 0;
  STAGE_KIND_SOURCE      = 1;
  STAGE_KIND_FILTER      = 2;
  STAGE_KIND_TOKENIZE    = 3;
  STAGE_KIND_WCOUNT      = 4;
  STAGE_KIND_SINK        = 5;
}

message Hello {
  StageKind kind = 1;   // which stage this process implements
  string    id   = 2;   // replica id (e.g., "W1")
  string    addr = 3;   // listen address (host:port) of this worker
}

message Config {
  string downstream_addr = 1;
}

message Barrier { int64 epoch = 1; }
message Ack { bool ok = 1; string reason = 2; }

message AckBarrierReq  { StageKind kind = 1; string id = 2; int64 epoch = 3; }
message AckBarrierResp { bool ok = 1; }

// Single req -> single res pattern
service Registry {
  rpc Register(Hello) returns (Config);
  rpc AckBarrier(AckBarrierReq) returns (AckBarrierResp);
}

// client: controller -> server: source node
// controller calls ReceiveBarrier(Barrier) -> actually it sends
// and then, source node receives the barrier, returns ack
service Worker {
  rpc ReceiveBarrier(Barrier) returns (Ack);
}
